# アクティブコンテキスト

## 現在の作業の焦点

現在、`PhaseController`の複数条件を持つフェーズの管理機能のテストと改善を行っています。特に、OR条件を持つフェーズの状態遷移に関するテストの修正を行いました。

## 最近の変更

### PhaseControllerのテスト修正

`TestPhaseControllerWithMultipleConditions`テストの`Phase2_OR_Condition`サブテストが失敗していた問題を修正しました。

#### 問題の詳細

テストログの分析から、以下の問題が特定されました：

1. `Phase2`が既に`finish`状態になっていた可能性があり、`controller.Start(ctx)`が失敗していました。
2. `Phase3`が`active`状態になっていたため、テストの期待する状態遷移が発生しませんでした。

#### 修正内容

`internal/usecase/state/phase_controller_multiple_conditions_test.go`ファイルの`Phase2_OR_Condition`サブテストを以下のように修正しました：

```go
// Phase2とPhase3の状態をリセットする
_ = phase2.Reset(ctx)
_ = phase3.Reset(ctx)

// Phase2を明示的にactive状態にする
_ = phase2.Activate(ctx)

// 現在のフェーズをPhase2に設定
controller.SetCurrentPhase(phase2.Name)
```

この修正により、テストの前提条件が明確に設定され、テスト間の独立性が確保されました。

## 現在の課題

1. **フェーズ状態の管理**: 複数のフェーズが関連するテストでは、各フェーズの状態を明示的に制御する必要があります。
2. **テスト間の独立性**: テスト実行の順序によって、前のテストの状態が次のテストに影響を与える可能性があります。
3. **条件評価のタイミング**: 時間ベースの条件評価と手動トリガーの条件評価の組み合わせが複雑な状態遷移を引き起こす可能性があります。

## 次のステップ

1. **テストの強化**: 他のテストケースも同様の問題がないか確認し、必要に応じて修正します。
2. **テスト間の独立性の確保**: 各テストの前に明示的に状態をリセットするヘルパー関数の導入を検討します。
3. **ドキュメントの更新**: 複雑な状態遷移のテスト方法に関するドキュメントを追加します。
4. **コードリファクタリング**: 状態遷移のロジックをより明確にし、テスト容易性を向上させます。

## アクティブな決定事項

1. テストの前提条件を明確に設定し、テスト間の独立性を確保することが重要です。
2. 複数のフェーズが関連するテストでは、各フェーズの状態を明示的に制御する必要があります。
3. テストの実行順序に依存しないテスト設計を心がけます。