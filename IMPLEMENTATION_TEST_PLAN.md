# テスト実装計画

## 1. 単体テスト (Unit Tests)

### 1.1 GameState パッケージ (`internal/domain/core/game_state_test.go`)

```go
// テストケース
- GetGameStateInfo()の基本動作
  - 各状態の情報が正しく返却されることを確認
  - 存在しない状態の場合にnilが返却されることを確認
- 状態遷移の検証
  - 各状態からの許可された遷移を確認
  - 不正な遷移が拒否されることを確認
```

### 1.2 StateSubject パッケージ (`internal/domain/core/state_subject_test.go`)

```go
// テストケース
- Observer登録/削除
  - 正常な登録と削除の確認
  - 重複登録の処理
  - 存在しないObserverの削除
- 状態変更通知
  - 複数Observerへの通知
  - 通知順序の確認
  - 並行アクセス時の動作
```

### 1.3 IntervalTimer パッケージ (`internal/domain/core/interval_timer_test.go`)

```go
// テストケース
- タイマー基本機能
  - 開始/停止の動作確認
  - インターバル更新の確認
  - 通知の正確性
- エッジケース
  - 重複開始の処理
  - 停止済みタイマーの停止
  - 短いインターバルでの動作
```

### 1.4 Phase エンティティ (`internal/domain/entity/phase_test.go`)

```go
// テストケース
- インスタンス生成
  - 正しいパラメータでの生成
  - デフォルト値の確認
  - タイマー初期化の確認

- 状態遷移
  - Ready → Active
  - Active → Next
  - Next → Finish
  - 各状態からのReset
  - 不正な遷移の検証

- タイマー制御
  - インターバル設定
  - タイマー開始/停止
  - タイマーイベントによる状態遷移

- FSMコールバック
  - 各状態遷移時のコールバック実行
  - isActiveフラグの更新
  - タイマー制御の確認

- Observer通知
  - 状態変更通知の伝播
  - タイマーイベントの処理
```

### 1.5 Phases コレクション (`internal/domain/entity/phases_test.go`)

```go
// テストケース
- Current()メソッド
  - アクティブなフェーズの取得
  - フェーズなしの場合の処理
  - 複数アクティブの場合の処理

- ResetAll()メソッド
  - 全フェーズのリセット
  - エラー発生時の処理
  - 部分的なリセットの処理

- ProcessOrder()メソッド
  - 最初のフェーズの開始
  - 次のフェーズへの遷移
  - 最後のフェーズの処理
  - エラー発生時の処理
```

## 2. 結合テスト (Integration Tests)

### 2.1 状態管理システム (`internal/domain/core/state_management_integration_test.go`)

```go
// テストケース
- 状態遷移とObserver通知の連携
  - 状態変更時のObserver通知確認
  - 複数の状態遷移シーケンス
- タイマーと状態遷移の連携
  - タイマーイベントによる状態遷移
  - 状態に応じたタイマー制御
```

### 2.2 フェーズ管理システム (`internal/domain/entity/phase_integration_test.go`)

```go
// テストケース
- フェーズ遷移シーケンス
  - 複数フェーズの順序制御
  - タイマーによる自動遷移
  - Observer通知の伝播

- エラー処理
  - フェーズ遷移エラーの処理
  - タイマーエラーの処理
  - 並行アクセスの制御

- リセット動作
  - 全体リセットの動作確認
  - 部分リセットの動作確認
  - リセット後の再開
```

## 3. テストユーティリティ

### 3.1 Core パッケージ (`internal/domain/core/test_utils.go`)

```go
// ユーティリティ関数
- モックObserver作成
- テスト用タイマー制御
- 状態遷移ヘルパー
- アサーション関数
```

### 3.2 Entity パッケージ (`internal/domain/entity/test_utils.go`)

```go
// ユーティリティ関数
- テスト用Phase作成
- モックFSM作成
- フェーズシーケンス作成
- アサーション関数
```

## 4. テストカバレッジ目標

- 全体カバレッジ: 80%以上
- 重要コンポーネント（状態遷移、Observer通知）: 90%以上
- エッジケース: できるだけ多くのシナリオをカバー

## 5. テスト実装方針

### 5.1 テストの構造
- テーブル駆動テスト形式を採用
- 各テストケースに日本語のコメントで目的を明記
- 前提条件、実行内容、期待結果を明確に記述

### 5.2 モック利用
- 外部依存（タイマー、ロガー）はインターフェースを通じてモック化
- テスト用のObserverはモックで実装

### 5.3 並行処理テスト
- race detectorを活用
- タイムアウト処理の実装
- ゴルーチンリークの検出

## 6. 実装順序

1. テストユーティリティの実装
2. 基本的な単体テストの実装
3. 結合テストの実装
4. エッジケースのテスト追加
5. カバレッジ分析と改善

## 7. 品質基準

- すべてのテストが信頼性高く実行可能であること
- フレーキーテストを含まないこと
- テストの実行時間が適切であること
- テストコードの可読性が高いこと